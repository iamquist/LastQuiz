<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />

    <title>Dream House</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="script/aframe.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/three@0.137.0/examples/js/loaders/RGBELoader.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/three@0.137.0/examples/js/loaders/EXRLoader.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: sans-serif;
        overflow: hidden;
        background: #000;
      }
      #controls-panel {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: #00ff00;
        padding: 15px;
        border-radius: 8px;
        z-index: 1000;
        border: 1px solid #00ff00;
        font-family: monospace;
        font-size: 12px;
      }
      .key {
        background: #00ff00;
        color: #000;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: bold;
      }
      #loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: #00ff00;
        padding: 30px;
        z-index: 1001;
        text-align: center;
        border: 2px solid #00ff00;
      }
    </style>
  </head>

  <body>
    <div id="loading"><h3>⚡ LOADING ENVIRONMENT ⚡</h3></div>

    <div id="controls-panel">
      <h4>⌨ CONTROLS</h4>

      <div style="margin-top: 5px">
        <span class="key">W,A,S,D</span> Move (Directional)
      </div>

      <div><span class="key">SPACE/CTRL</span> Up/Down</div>

      <div><span class="key">SHIFT</span> Boost</div>
    </div>

    <a-scene
      id="main-scene"
      vr-mode-ui="enabled: false"
      renderer="colorManagement: true; exposure: 0.9; toneMapping: ACESFilmic"
    >
      <a-assets>
        <a-asset-item id="Model" src="model/quist.glb"></a-asset-item>
      </a-assets>

      <a-entity id="environment-container">
        <a-entity
          id="environment"
          geometry="primitive: sphere; radius: 500"
          material="shader: flat; side: back"
        ></a-entity>
      </a-entity>

      <a-entity
        id="character"
        gltf-model="#Model"
        animation-mixer
        position="0 -40 -230"
        rotation="0 -90 0"
        scale="4 4 4"
      ></a-entity>

      <a-light type="ambient" intensity="0.4"></a-light>
      <a-light type="directional" intensity="0.8" position="5 10 5"></a-light>

      <a-entity id="player" position="-10 10 -60">
        <a-camera id="main-camera" look-controls="enabled: false"></a-camera>
      </a-entity>
    </a-scene>

    <script>
      class NavigationController {
        constructor() {
          this.keys = {};
          this.velocity = new THREE.Vector3();
          this.position = new THREE.Vector3(-10, 10, -60);
          this.theta = 0;
          this.phi = 0;
          this.init();
        }

        async init() {
          const sceneEl = document.querySelector("a-scene");
          sceneEl.addEventListener("loaded", () => {
            this.scene = sceneEl.object3D;
            this.player = document.getElementById("player");
            this.camera = document.getElementById("main-camera").object3D;
            this.setupEnvironment();
            this.setupInput();
            this.startUpdateLoop();
            document.getElementById("loading").style.display = "none";
          });
        }

        setupEnvironment() {
          const exrLoader = new THREE.EXRLoader();
          exrLoader.load("texture/env.exr", (texture) => {
            texture.mapping = THREE.EquirectangularReflectionMapping;
            this.scene.environment = texture; // Reflections

            const envMesh = document
              .getElementById("environment")
              .getObject3D("mesh");
            if (envMesh) {
              envMesh.material = new THREE.MeshBasicMaterial({
                map: texture,
                side: THREE.BackSide,
                toneMapped: true, // Ensures texture respects renderer exposure
              });
            }
          });
        }

        setupInput() {
          document.addEventListener(
            "keydown",
            (e) => (this.keys[e.key.toLowerCase()] = true),
          );
          document.addEventListener(
            "keyup",
            (e) => (this.keys[e.key.toLowerCase()] = false),
          );
          document.addEventListener("mousemove", (e) => {
            if (document.pointerLockElement) {
              this.theta -= e.movementX * 0.002;
              this.phi -= e.movementY * 0.002;
              this.phi = Math.max(-1.5, Math.min(1.5, this.phi));
            }
          });
          document.body.onclick = () => document.body.requestPointerLock();
        }

        startUpdateLoop() {
          let lastTime = performance.now();
          const update = (now) => {
            const dt = (now - lastTime) / 1000;
            lastTime = now; // 1. Calculate direction vectors based on Y-axis (theta) only
            // This prevents moving "into the ground" when looking down

            const forward = new THREE.Vector3(
              Math.sin(this.theta),
              0,
              Math.cos(this.theta),
            );
            const right = new THREE.Vector3(
              Math.sin(this.theta - Math.PI / 2),
              0,
              Math.cos(this.theta - Math.PI / 2),
            );

            let moveDir = new THREE.Vector3(0, 0, 0);

            if (this.keys["w"]) moveDir.add(forward.negate());
            if (this.keys["s"]) moveDir.add(forward);
            if (this.keys["a"]) moveDir.add(right.negate());
            if (this.keys["d"]) moveDir.add(right); // Vertical movement

            if (this.keys[" "]) moveDir.y += 1;
            if (this.keys["control"]) moveDir.y -= 1;

            let speed = this.keys["shift"] ? 40 : 12; // Apply movement

            if (moveDir.length() > 0) {
              moveDir.normalize().multiplyScalar(speed);
            }

            this.velocity.lerp(moveDir, 0.1);
            this.position.add(this.velocity.clone().multiplyScalar(dt)); // Update Entities

            this.player.setAttribute("position", this.position);
            document
              .getElementById("environment-container")
              .setAttribute("position", this.position); // Update Camera Rotation

            this.camera.quaternion.setFromEuler(
              new THREE.Euler(this.phi, this.theta, 0, "YXZ"),
            );

            requestAnimationFrame(update);
          };
          requestAnimationFrame(update);
        }
      }
      new NavigationController();
    </script>
     
  </body>
</html>
